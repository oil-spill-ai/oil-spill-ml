# Oil Spill AI ML Service

Микросервис для сегментации разливов нефти на спутниковых изображениях. Реализован на FastAPI, использует модель YOLO (Ultralytics) и предназначен для интеграции с backend или самостоятельного тестирования.

---

## Архитектура

- **FastAPI** — REST API для приёма изображений, проверки статуса и управления временными файлами.
- **YOLO (Ultralytics)** — модель сегментации, загружается при старте сервиса.
- **/tmp/uploads, /tmp/results** — временные директории для хранения входных и выходных файлов.

---

## Как устроен модуль

### Основные компоненты

- **FastAPI-приложение (`app/main.py`)**
  - `/segment` — принимает изображение, сохраняет во временную папку, вызывает функцию сегментации, возвращает результат.
  - `/health` — проверка работоспособности сервиса.
  - `/stats` — возвращает статистику по количеству обработанных запросов и среднему времени обработки.
  - `/clear-tmp` — удаляет все временные файлы из папок `/tmp/uploads` и `/tmp/results`.

- **Модель сегментации (`app/model.py`, `app/predict.py`)**
  - Модель YOLO загружается один раз при старте сервиса.
  - `predict_image` — функция, вызывающая модель для сегментации изображения и сохраняющая результат.

- **Вспомогательные функции (`app/utils.py`)**
  - Логирование запросов и результатов.
  - Подсчёт статистики (общее количество запросов, среднее время обработки).
  - Очистка временных файлов.

### Жизненный цикл запроса

1. Пользователь отправляет изображение на `/segment`.
2. Изображение сохраняется во временную папку.
3. Запускается функция сегментации (`predict_image`), результат сохраняется в `/tmp/results/job_results`.
4. Сегментированное изображение возвращается пользователю.
5. Временный входной файл удаляется.
6. В любой момент можно получить статистику (`/stats`) или очистить временные файлы (`/clear-tmp`).

### Хранение данных

- Входные изображения: `/tmp/uploads`
- Результаты сегментации: `/tmp/results/job_results`
- Все временные файлы можно удалить через эндпоинт `/clear-tmp`.

### Конфигурация

- Пути к временным папкам заданы в коде (`/tmp/uploads`, `/tmp/results`). Для изменения — скорректируйте переменные в `app/main.py` и `app/utils.py`.
- Модель загружается из `weights/best.pt` (относительно корня проекта).

---

## Быстрый старт

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

2. Запустите сервис:
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8002
   # или ./run.sh
   ```

---

## API

- `POST /segment` — принимает изображение (multipart/form-data, поле `file`), возвращает результат сегментации (image/jpeg).
- `GET /health` — проверка работоспособности (возвращает JSON: `{"status": "ok"}`).
- `GET /stats` — статистика обработки (общее количество запросов, среднее время обработки).
- `POST /clear-tmp` — очистка временных файлов.

---

## Структура проекта

```
ml/
├── app/
│   ├── main.py        # FastAPI-приложение, основные эндпоинты
│   ├── model.py       # Загрузка модели YOLO
│   ├── predict.py     # Функция сегментации изображений
│   ├── utils.py       # Логирование, статистика, очистка временных файлов
├── weights/
│   └── best.pt        # Весы модели YOLO
├── requirements.txt   # Зависимости Python
├── Dockerfile         # Docker-образ (опционально)
├── run.sh             # Скрипт для запуска сервиса
└── README.md          # Документация (этот файл)
```

---

## Зависимости

- fastapi
- uvicorn
- ultralytics
- torch
- torchvision
- opencv-python
- numpy
- pillow
- python-multipart
- requests
- и другие (см. `requirements.txt`)

Установите все зависимости командой:
```bash
pip install -r requirements.txt
```

---

## Примечания

- Для работы требуется файл весов модели: `weights/best.pt`.
- Все временные файлы хранятся в `/tmp/uploads` и `/tmp/results`.
- Для интеграции с backend используйте HTTP-запросы к эндпоинтам сервиса.
- Для тестирования можно использовать `curl`:
  ```bash
  curl -F "file=@test.jpg" http://localhost:8002/segment --output result.jpg
  ```
- Для изменения путей хранения временных файлов скорректируйте переменные в коде.